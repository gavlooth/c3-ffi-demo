;; test_string_last_index_of.omni - Tests for string-last-index-of primitive
;;
;; Tests string-last-index-of function which finds the LAST occurrence of a substring.
;; This is important for text parsing, path manipulation, and finding patterns
;; from the end of strings (e.g., file extensions, trailing delimiters).
;;
;; Run with: ./omni tests/test_string_last_index_of.omni

;; ============================================================
;; Test Framework
;; ============================================================

(define test-count 0)
(define pass-count 0)
(define fail-count 0)

(define test-int [name] [expected] [actual]
  (set! test-count (+ test-count 1))
  (if (= expected actual)
      (do
        (set! pass-count (+ pass-count 1))
        (print "PASS:" name))
      (do
        (set! fail-count (+ fail-count 1))
        (print "FAIL:" name)
        (print "  Expected:" expected)
        (print "  Got:" actual))))

;; ============================================================
;; Test 1: Basic last substring search
;; ============================================================

(print "")
(print "=== Test 1: Basic Last Substring Search ===")

(test-int "find last 'l' in 'hello'"
  3
  (string-last-index-of "hello" "l"))

(test-int "find 'world' at end"
  6
  (string-last-index-of "hello world" "world"))

(test-int "find 'hello' at beginning"
  0
  (string-last-index-of "hello world" "hello"))

;; ============================================================
;; Test 2: Substring not found
;; ============================================================

(print "")
(print "=== Test 2: Substring Not Found ===")

(test-int "substring not present returns -1"
  -1
  (string-last-index-of "hello world" "xyz"))

(test-int "empty pattern not in string"
  -1
  (string-last-index-of "hello" "world"))

;; ============================================================
;; Test 3: Single character search
;; ============================================================

(print "")
(print "=== Test 3: Single Character Search ===")

(test-int "find last 'e' in 'hello'"
  1
  (string-last-index-of "hello" "e"))

(test-int "find last 'l' in 'hello'"
  3
  (string-last-index-of "hello" "l"))

(test-int "character at beginning"
  0
  (string-last-index-of "hello" "h"))

(test-int "character at end"
  4
  (string-last-index-of "hello" "o"))

;; ============================================================
;; Test 4: Multiple occurrences
;; ============================================================

(print "")
(print "=== Test 4: Multiple Occurrences ===")

(test-int "find last 'a' in 'banana'"
  5
  (string-last-index-of "banana" "a"))

(test-int "find last 'll' in 'hello hello'"
  9
  (string-last-index-of "hello hello" "ll"))

(test-int "find last 'o' in 'hello world'"
  7
  (string-last-index-of "hello world" "o"))

;; ============================================================
;; Test 5: Empty strings
;; ============================================================

(print "")
(print "=== Test 5: Empty Strings ===")

(test-int "empty pattern in non-empty string returns length"
  5
  (string-last-index-of "hello" ""))

(test-int "empty pattern in empty string"
  0
  (string-last-index-of "" ""))

;; ============================================================
;; Test 6: Pattern equals string
;; ============================================================

(print "")
(print "=== Test 6: Pattern Equals String ===")

(test-int "pattern equals entire string"
  0
  (string-last-index-of "hello" "hello"))

(test-int "pattern longer than string not found"
  -1
  (string-last-index-of "hi" "hello"))

;; ============================================================
;; Test 7: Overlapping patterns
;; ============================================================

(print "")
(print "=== Test 7: Overlapping Patterns ===")

(test-int "find last 'aa' in 'aaaa'"
  2
  (string-last-index-of "aaaa" "aa"))

(test-int "find last 'aba' in 'ababa'"
  2
  (string-last-index-of "ababa" "aba"))

;; ============================================================
;; Test 8: Case sensitivity
;; ============================================================

(print "")
(print "=== Test 8: Case Sensitivity ===")

(test-int "case sensitive - uppercase not found"
  -1
  (string-last-index-of "Hello" "h"))

(test-int "case sensitive - exact match"
  0
  (string-last-index-of "Hello" "H"))

(test-int "case sensitive - mixed case not found"
  -1
  (string-last-index-of "HelloWorld" "h"))

;; ============================================================
;; Test 9: Whitespace and special characters
;; ============================================================

(print "")
(print "=== Test 9: Whitespace and Special Characters ===")

(test-int "find last space character"
  5
  (string-last-index-of "hello world" " "))

(test-int "find last tab character"
  5
  (string-last-index-of "hello\tworld" "\t"))

(test-int "find last punctuation"
  5
  (string-last-index-of "hello,world," ","))

(test-int "find last dot"
  4
  (string-last-index-of "file.txt" "."))

;; ============================================================
;; Test 10: Numbers and digits
;; ============================================================

(print "")
(print "=== Test 10: Numbers and Digits ===")

(test-int "find last digit"
  2
  (string-last-index-of "abc123" "3"))

(test-int "find last number pattern"
  6
  (string-last-index-of "abc123def456" "456"))

(test-int "find repeated digit"
  4
  (string-last-index-of "112233" "2"))

;; ============================================================
;; Test 11: Single character strings
;; ============================================================

(print "")
(print "=== Test 11: Single Character Strings ===")

(test-int "last index in single char string"
  0
  (string-last-index-of "a" "a"))

(test-int "not found in single char string"
  -1
  (string-last-index-of "a" "b"))

;; ============================================================
;; Test 12: Long strings and patterns
;; ============================================================

(print "")
(print "=== Test 12: Long Strings ===")

(test-int "find pattern at very end"
  15
  (string-last-index-of "hello world test" "test"))

(test-int "find pattern in long string"
  6
  (string-last-index-of "hello world hello again" "hello"))

;; ============================================================
;; Test 13: Difference between first and last
;; ============================================================

(print "")
(print "=== Test 13: First vs Last ===")

;; Verify first-index-of and last-index-of differ
(define test-str "hello hello hello")
(test-int "first 'hello' should be at index 0"
  0
  (string-index-of test-str "hello"))

(test-int "last 'hello' should be at index 12"
  12
  (string-last-index-of test-str "hello"))

;; ============================================================
;; Test 14: Repeated patterns
;; ============================================================

(print "")
(print "=== Test 14: Repeated Patterns ===")

(test-int "find last of repeated 'abc'"
  6
  (string-last-index-of "abcabcabc" "abc"))

(test-int "find last of repeated single char"
  4
  (string-last-index-of "aaaaa" "a"))

;; ============================================================
;; Test 15: File extension pattern (practical use case)
;; ============================================================

(print "")
(print "=== Test 15: File Extension Pattern ===")

(test-int "find last dot in file path"
  8
  (string-last-index-of "/path/to/file.txt" "."))

(test-int "find last slash in file path"
  7
  (string-last-index-of "/path/to/file.txt" "/"))

;; ============================================================
;; Test Results
;; ============================================================

(print "")
(print "=== Test Results ===")
(print "Total:" test-count)
(print "Passed:" pass-count)
(print "Failed:" fail-count)

(if (= fail-count 0)
    (print "ALL TESTS PASSED!")
    (print "SOME TESTS FAILED"))

;; Return count of failures (0 = success)
fail-count
