;; test_sort_by.omni - Comprehensive tests for sort-by primitive
;;
;; Tests prim_sort_by function (exposed as sort-by in OmniLisp)
;; which sorts lists and arrays by applying a key function to each element.

;; ============================================================
;; Test Framework
;; ============================================================

(define test-count 0)
(define pass-count 0)
(define fail-count 0)

(define test-eq [name] [expected] [actual]
  (set! test-count (+ test-count 1))
  (if (equal? expected actual)
      (do
        (set! pass-count (+ pass-count 1))
        (print "PASS:" name))
      (do
        (set! fail-count (+ fail-count 1))
        (print "FAIL:" name)
        (print "  Expected:" expected)
        (print "  Got:" actual))))

;; ============================================================
;; Array Sort-by Tests
;; ============================================================

(print "")
(print "=== Array Sort-by Tests ===")

;; Test 1: Empty array
(test-eq "empty array"
  []
  (sort-by identity []))

;; Test 2: Single element array
(test-eq "single element array"
  [1]
  (sort-by identity [1]))

;; Test 3: Sort array by absolute value
(test-eq "sort by absolute value"
  [-3 -1 2 4 5]
  (sort-by abs [-3 2 -1 4 5]))

;; Test 4: Sort array of strings by length
(test-eq "sort strings by length"
  ["a" "ab" "abc" "abcd"]
  (sort-by string-length ["abcd" "a" "abc" "ab"]))

;; Test 5: Sort array by squaring each element (key doesn't modify values)
(test-eq "sort by squared value, values unchanged"
  [1 2 3 4 5]
  (sort-by (fn [x] (* x x)) [3 1 4 2 5]))

;; Test 6: Sort array of pairs by first element
(test-eq "sort pairs by first element"
  [[1 "a"] [2 "b"] [3 "c"]]
  (sort-by first [[3 "c"] [1 "a"] [2 "b"]]))

;; Test 7: Sort array of pairs by second element
(test-eq "sort pairs by second element"
  [["a" 1] ["b" 2] ["c" 3]]
  (sort-by second [["b" 2] ["a" 1] ["c" 3]]))

;; Test 8: Non-destructive - original array unchanged
(define original-array [3 1 4 1 5])
(define sorted-array (sort-by abs original-array))
(test-eq "original array unchanged after sort-by"
  [3 1 4 1 5]
  original-array)

;; ============================================================
;; List Sort-by Tests
;; ============================================================

(print "")
(print "=== List Sort-by Tests ===")

;; Test 9: Empty list
(test-eq "empty list"
  ()
  (sort-by identity ()))

;; Test 10: Single element list
(test-eq "single element list"
  '(1)
  (sort-by identity '(1)))

;; Test 11: Sort list by absolute value
(test-eq "sort list by absolute value"
  '(-3 -1 2 4 5)
  (sort-by abs '(-3 2 -1 4 5)))

;; Test 12: Sort list of strings by length
(test-eq "sort list of strings by length"
  '("a" "ab" "abc" "abcd")
  (sort-by string-length '("abcd" "a" "abc" "ab")))

;; Test 13: Sort list by negating values (reverse sort)
(test-eq "sort by negated value (reverse order)"
  [5 4 3 2 1]
  (sort-by (fn [x] (* x -1)) [1 2 3 4 5]))

;; Test 14: Sort list of pairs by first element
(test-eq "sort list of pairs by first element"
  '([1 "a"] [2 "b"] [3 "c"])
  (sort-by first '([3 "c"] [1 "a"] [2 "b"])))

;; Test 15: Non-destructive - original list unchanged
(define original-list '(3 1 4 1 5))
(define sorted-list (sort-by abs original-list))
(test-eq "original list unchanged after sort-by"
  '(3 1 4 1 5)
  original-list)

;; ============================================================
;; Edge Cases and Idempotence
;; ============================================================

(print "")
(print "=== Edge Cases and Idempotence ===")

;; Test 16: All elements have same key
(test-eq "all same keys - stable order"
  [1 2 3]
  (sort-by (fn [x] 0) [1 2 3]))

;; Test 17: Key function returns strings
(test-eq "sort by string key function"
  [10 20 30]
  (sort-by (fn [x] (string-append "key-" (number->string x))) [20 10 30]))

;; Test 18: Double sort-by is idempotent for array
(define arr [3 1 4 1 5])
(test-eq "double sort-by array"
  (sort-by abs arr)
  (sort-by abs (sort-by abs arr)))

;; Test 19: Double sort-by is idempotent for list
(define lst '(3 1 4 1 5))
(test-eq "double sort-by list"
  (sort-by abs lst)
  (sort-by abs (sort-by abs lst)))

;; Test 20: Sort mixed positive/negative numbers by absolute value
(test-eq "mixed positives and negatives by abs"
  [0 1 -2 3 -4]
  (sort-by abs [3 -4 1 0 -2]))

;; ============================================================
;; Results
;; ============================================================

(print "")
(print "=== Test Results ===")
(print "Total:" test-count)
(print "Passed:" pass-count)
(print "Failed:" fail-count)

(if (= fail-count 0)
    (print "ALL TESTS PASSED!")
    (print "SOME TESTS FAILED"))

;; Return count of failures (0 = success)
fail-count
